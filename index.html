<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Document</title>
        <style>
            *{
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            }

            /**************************** TABLE STYLES ****************************/   
			.table-container{
				display: none;
			}

            table {
                /* border-collapse sets the table's elements to share borders, rather than floating as separate "boxes". */
                border-collapse: collapse;
                width: 100%;
            }

            td,
            th {
                border: .0625rem solid rgb(189, 189, 189);
                text-align: left;
                padding: .5rem;
            }


            th {
                background: #f8f9fa;
            }


            tr:nth-child(even) {
                /* Set every other cell slightly darker. Improves readability. */
                background: #f8f9fa;
            }

            table caption {
                font-weight: bold;
                margin-bottom: .6rem;
            }

                        
            /* BUTTONS */
            a /* Link */ button,
            button,
            input[type="submit"],
            input[type="reset"],
            input[type="button"] {
                display: inline-block;
                padding: 6px 12px;
                text-align: center;
                text-decoration: none;
                white-space: nowrap;
                background: #d2f1fa;
                border: none;
                border-radius: .45em;
                box-sizing: border-box;
                cursor: pointer;
            }

            button:hover{
                background-color: #6fd4f0;
            }
            /**************************** TABLE STYLES ****************************/


            button:active{
                background-color: #40a2bd;
            }

            label{
                margin-right: 1rem;
                font-size: 1.2rem;
            }

            .form-container {
                margin-top: .5rem;
                display: block;
                text-align: center;
                display: none;
            }

            .card{
                background-color: #c9e5ed;
                width: 20%;
                margin: auto;
                border-radius: 5px;
                padding: 1.5rem;
            }

            form{
                display: inline-block;
                margin-left: auto;
                margin-right: auto;
                text-align: left;
            }

            form > label, form > input {
                display:block;
            }

            form > input {
                margin-bottom: .2rem;
            }

            .form-select{
                display: block;
                margin-left: auto;
                margin-right: auto;
                text-align: left;
                visibility: hidden;
            }

            .abm-buttons{
                margin-top: .5rem;
            }

            .add-btn-container{
                text-align: center;  
                width: 100%;
            }

            .add-btn{
                margin-top: .8rem;
                text-align: center;
				display: none;
            }


            /**************************** SPINNER ****************************/
			.spinner-container{
				background-color: rgba(0, 0, 0, 0.695);
				width: 102vw;
				height: 100vh;
				position:fixed;
				margin-left: -1rem;
				margin-right: -1rem;
				display: flex;
			}

			.lds-roller {
				display: inline-block;
				position: relative;
				width: 80px;
				height: 80px;
				margin: auto;
			}
			.lds-roller div {
				animation: lds-roller 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
				transform-origin: 40px 40px;
			}
			.lds-roller div:after {
				content: " ";
				display: block;
				position: absolute;
				width: 7px;
				height: 7px;
				border-radius: 50%;
				background: #fff;
				margin: -4px 0 0 -4px;
			}
			.lds-roller div:nth-child(1) {
				animation-delay: -0.036s;
			}
			.lds-roller div:nth-child(1):after {
				top: 63px;
				left: 63px;
			}
			.lds-roller div:nth-child(2) {
				animation-delay: -0.072s;
			}
			.lds-roller div:nth-child(2):after {
				top: 68px;
				left: 56px;
			}
			.lds-roller div:nth-child(3) {
				animation-delay: -0.108s;
			}
			.lds-roller div:nth-child(3):after {
				top: 71px;
				left: 48px;
			}
			.lds-roller div:nth-child(4) {
				animation-delay: -0.144s;
			}
			.lds-roller div:nth-child(4):after {
				top: 72px;
				left: 40px;
			}
			.lds-roller div:nth-child(5) {
				animation-delay: -0.18s;
			}
			.lds-roller div:nth-child(5):after {
				top: 71px;
				left: 32px;
			}
			.lds-roller div:nth-child(6) {
				animation-delay: -0.216s;
			}
			.lds-roller div:nth-child(6):after {
				top: 68px;
				left: 24px;
			}
			.lds-roller div:nth-child(7) {
				animation-delay: -0.252s;
			}
			.lds-roller div:nth-child(7):after {
				top: 63px;
				left: 17px;
			}
			.lds-roller div:nth-child(8) {
				animation-delay: -0.288s;
			}
			.lds-roller div:nth-child(8):after {
				top: 56px;
				left: 12px;
			}
			@keyframes lds-roller {
			0% {
				transform: rotate(0deg);
			}
			100% {
				transform: rotate(360deg);
			}
			}

            /**************************** SPINNER ****************************/

        </style>
    </head>
    <body>

		<!-- SPINNER -->
		<div id="spinnerContainer" class="spinner-container">
			<div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
		</div>
		<!-- SPINNER -->


		<div id="tableContainer" class="table-container">
			<table id="dataTable" class="content-table">
					<thead id="tableHead">
						<th> </th>
				</thead>
				<tbody id="tableBody">
					<tr>
						<td></td>
					</tr>
				</tbody>
			</table>
		</div>

        <div class="add-btn-container">
            <button onclick="onAdd()" id="addButton" class="add-btn">Agregar</button>
        </div>

        <div class="form-container" id="formContainer">
            <div class="card">
                <select class="form-select" name="formSelect" id="formSelect">
                    <option value="Camioneta">Camioneta</option>
                    <option value="Auto">Auto</option>
                </select>
                <form id="abmForm">
                </form>
                <div class="abm-buttons">
                    <button id="deleteButton" onclick="onDeleteForm()">Eliminar</button>
                    <button id="editButton" onclick="onEdit()">Modificar</button>
                    <button onclick="onAccept()">Aceptar</button>
                    <button onclick="onCancel()">Cancelar</button>
                </div>
            </div>
        </div>

    </body>


    <script>
		
		let strJson = '';

        var propNames = ['id', 'fabricante', 'modelo', 'añoLanzamiento', 'cantidadPuertas', 'transmision4x4' ];
        var tableHeaders = ['Id', 'Fabricante', 'Modelo', 'Año de lanzamiento', 'Cantidad de puertas', 'Transmisión 4x4', 'Modificar', 'Eliminar'];
        var filterValue = '';
        var isFormActivated = false;
		var globalMode = '';
		let finalOutputArray;

		function getInitialData(){
			toggleTable();
			getDataByFetch('https://localhost:5001/Vehiculos/Vehiculos').then( response => {
				if (response.status == 200) {
					response.text().then( strJson => {
						let newArray = jsonToArray(strJson); // Parsea los datos obtenidos a array

						finalOutputArray = arrayToObject(newArray); // Convierte el array al objeto correspondiente

						renderTable(finalOutputArray, propNames);
						let btn = document.getElementById('addButton');
						btn.style.display = 'initial';

						toggleSpinner();
					});
				}else{
					serverError();
				}
			});
		}

        function jsonToArray(jsonString){
            return JSON.parse(jsonString);
        }

        class Persona {
            id;
            fabricante;
            modelo;
            añoLanzamiento;

            constructor(id, fabricante, modelo, añoLanzamiento) {
                this.fabricante = fabricante;
                this.modelo = modelo;
                this.añoLanzamiento = añoLanzamiento;

                if (id) {
                    this.id = id;
                } else {
                    this.id = getMaxId() + 1;
                }
            }

			setAñoLanzamiento(añoLanzamiento){
				if (!isNaN(añoLanzamiento) && añoLanzamiento >= 2) {
					this.añoLanzamiento = añoLanzamiento;
				}
			}

            toString(){
                let finalString = '';
                let objToArray = Object.entries(this);

                objToArray.map((element) => {
                    let key = element[0];
                    let value = element[1] || '';
                    finalString += key + ': ' + value + ' - ';
                });
                return finalString;
            }
        }


        class Auto extends Persona {
            cantidadPuertas;

            constructor(id, fabricante, modelo, añoLanzamiento, cantidadPuertas) {
                super(id, fabricante, modelo, añoLanzamiento);

                this.cantidadPuertas = cantidadPuertas;
            }

			setCantidadPuertas(cantidadPuertas){
				if (!isNaN(cantidadPuertas) && cantidadPuertas >= 2) {
					this.cantidadPuertas = cantidadPuertas;
				}
			}

            toString(){
                let finalString = '';
                let objToArray = Object.entries(this);

                objToArray.map((element) => {
                    let key = element[0];
                    let value = element[1] || '';
                    finalString += key + ': ' + value + ' - ';
                });
                return finalString;
            }
        }


        class Camioneta extends Persona {
            transmision4x4;

            constructor(id, fabricante, modelo, añoLanzamiento, transmision4x4, ) {
                super(id, fabricante, modelo, añoLanzamiento);

                this.transmision4x4 = transmision4x4;
            }

			setTransmision4x4(transmision4x4){
				let acceptedValues = ['SI', 'NO' ]
				if (acceptedValues.includes(transmision4x4)) {
					this.transmision4x4 = transmision4x4;
				}
			}

            toString(){
                let finalString = '';
                let objToArray = Object.entries(this);

                objToArray.map((element) => {
                    let key = element[0];
                    let value = element[1];
                    finalString += key + ': ' + value + '  ';
                });
                return finalString;
            }
        }

        
        function arrayToObject(arr) {
            let finalArray = new Array();
            let finalElement;
            arr.forEach(e => {
                if( e.hasOwnProperty('cantidadPuertas')) {
                    finalElement = new Auto( e.id, e.fabricante, e.modelo, e.añoLanzamiento, e.cantidadPuertas);
                } else if (e.hasOwnProperty('transmision4x4')) {
                    finalElement = new Camioneta( e.id, e.fabricante, e.modelo, e.añoLanzamiento, e.transmision4x4);
                }

                finalArray.push(finalElement);
            });
            return finalArray;
        }

        function getMaxId() {
            let maxId = finalOutputArray.map(x => { return x.id });
            maxId = Math.max(...maxId);

            return maxId;
        }


        /********************** CREACIÓN DE LA TABLA **********************/


        function createTableHeaders(headers) {
            let tableHead = document.getElementById('tableHead');
            tableHead.innerHTML = '';

            for (let i = 0; i < headers.length; i++) {
                const header = headers[i];


				let th = document.createElement("th");				
				th.appendChild(document.createTextNode(header));
				tableHead.appendChild(th);
            }
        }

        function createTableContent(dataSource, columnNames) {
            let tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            dataSource.forEach(e => {
                tr = document.createElement("tr");
                tr.setAttribute('id', e.id);

                for (let i = 0; i < columnNames.length; i++) {
                    const column = columnNames[i];
                    const header = tableHeaders[i];

					td = document.createElement("td");
					let cellText = e[column] || 'N/A';
					
					td.appendChild(document.createTextNode(cellText));
					tr.appendChild(td);
                }

				/********* BOTÓN MODIFICAR ********/
				td = document.createElement("td");
				btn = document.createElement("button");
				let btnText = 'Modificar';
				btn.appendChild(document.createTextNode(btnText));

				btn.addEventListener('click', function onRowDoubleClicked(event) {
                    renderForm(e, true);
                    
                });

				td.appendChild(btn);
				tr.appendChild(td);

				/********* BOTÓN Eliminar ********/
				td = document.createElement("td");
				btn = document.createElement("button");
				btnText = 'Eliminar';

				btn.addEventListener('click', function onRowDoubleClicked(event) {
                    renderForm(e, true);
                    
                });

				btn.appendChild(document.createTextNode(btnText));
				td.appendChild(btn);
				tr.appendChild(td);

                tableBody.appendChild(tr);

                let row = document.getElementById(e.id);
                row.addEventListener('dblclick', function onRowDoubleClicked(event) {
                    renderForm(e, true);
                    
                });
            });
        }
        

        function renderTable(fullDataSource, columnNames) {

            let filteredData = fullDataSource.filter(filterCriteria(filterValue));

            createTableHeaders(tableHeaders);
            createTableContent(filteredData, columnNames);
        }

        function calculateValue(fullDataSource){
            let filteredData = fullDataSource.filter(filterCriteria(filterValue));
            let avg = filteredData
                .map( function(a){ return a.id } )
                .reduce( function(a,b){ return (+a) + (+b) },) / filteredData.length;
            
            return avg;
        }


        function filterCriteria(selectedValue){

            return function filterObj(persona) {
                switch (selectedValue) {
                    case 'Auto':
                        return persona.hasOwnProperty('');
                        break;
                    case 'Camioneta':
                        return !persona.hasOwnProperty('');
                        break;
                    default:
                        return true;
                    break;
                }
            }
        }

		function toggleTable() {
			let tableContainer = document.getElementById('tableContainer');
			if (tableContainer.style.display == 'none' || !tableContainer.style.display) {
				tableContainer.style.display = 'flex'
				return;
			}
            tableContainer.style.display = 'none'; 
		}

		function toggleSpinner() {
			let spinnerContainer = document.getElementById('spinnerContainer');
			if (spinnerContainer.style.display == 'none') {
				spinnerContainer.style.display = 'flex'
				return;
			}
            spinnerContainer.style.display = 'none'; 
		}
        /********************** FIN CREACIÓN DE LA TABLA **********************/


        /********************** FORM **********************************/
        function renderForm(obj, isEditMode, mode){
			toggleTable();
			

            let form = document.getElementById('abmForm');
            form.innerHTML = '';

            let formSelect = document.getElementById('formSelect');
            let className = formSelect.value;
            let objToArray;

            if (obj) {
                formSelect.value = obj.constructor.name;
            }else {
                switch (className) {
                case 'Camioneta':
                    obj = new Camioneta();
					obj.id = null
                    break;
                case 'Auto':
                    obj = new Auto();
					obj.id = null
                    break;
                }
            }

            objToArray = Object.entries(obj);

            objToArray.map((element) => {
                let key = element[0];
                let value = element[1] || '';

                let label = document.createElement('label');
                
                label.appendChild( document.createTextNode(key.charAt(0).toUpperCase() + key.slice(1)) );

                let input = document.createElement('input');
                input.value = value;
                input.setAttribute('id', 'input' + key);
                input.setAttribute('class', 'form-input');

                label.setAttribute('for', 'input' + key);

                form.appendChild(label);
                form.appendChild(input);

                let formContainer = document.getElementById('formContainer');
                formContainer.style.display = 'block'; 
            })

            let idInput = document.getElementById('inputid');
            idInput.readOnly = true;

            isFormActivated = true;
            editMode(isEditMode);
            if (isEditMode) {
                formSelect.style.visibility = 'hidden';
            }else {
                formSelect.style.visibility = 'visible';
            }
        }

        function hideForm() {
			toggleTable();
            let formContainer = document.getElementById('formContainer');
            formContainer.style.display = 'none'; 
            isFormActivated = false;

            let addButton = document.getElementById('addButton');
            addButton.disabled = false;
        }

		let formSelect = document.getElementById('formSelect');
        formSelect.addEventListener('change', function onChange(event){
            renderForm();
			toggleTable();
        })


        function editMode(toggle) { 
            let editButton = document.getElementById('editButton');
            let deleteButton = document.getElementById('deleteButton');
            let addButton = document.getElementById('addButton');

            if (toggle) {
                editButton.disabled = false;
                deleteButton.disabled = false;
                addButton.disabled = true; 
            }else {
                editButton.disabled = true;
                deleteButton.disabled = true;
                addButton.disabled = false; 
            }
        }

		function onAccept(){
			switch (globalMode) {
				case 'edit':
					onEdit();
					break;
				case 'add':
					onAdd();
					break;
				case 'delete':
					onDeleteForm();
					break;
			
				default:
					break;
			}
		}
        /******************* FIN FORM *********************************/ 

        /************************** ABM ******************************/
        function getInputsValues(){
            let inputsArray = Array.from(document.getElementsByClassName('form-input'));
            let valuesArray = inputsArray.map(input => input.value);
            return valuesArray;
        }

        function fillInputsValues(){ // TODO: Completar con los valores del objeto obtenido.
            let inputsArray = Array.from(document.getElementsByClassName('form-input'));
            inputsArray.map(input => input.value = 3);
        }

        function onAdd(){
            if (isFormActivated) {
                let selectedValue = document.getElementById('formSelect').value;
                let valuesArray = getInputsValues();
                let newObj;
                let target;

				toggleSpinner();

                valuesArray[0] = 0; // Pongo el ID para que pase la validación. Luego se sobreescribe.

                switch (selectedValue) {
                    case 'Camioneta':
						newObj = new Camioneta();
						newObj.id = valuesArray[0];
						newObj.fabricante = valuesArray[1];
						newObj.modelo = valuesArray[2];
						newObj.setAñoLanzamiento(valuesArray[3]);
						newObj.setTransmision4x4(valuesArray[4]);
						break;
					case 'Auto':
						newObj = new Auto();
						newObj.id = valuesArray[0];
						newObj.fabricante = valuesArray[1];
						newObj.modelo = valuesArray[2];
						newObj.setAñoLanzamiento(valuesArray[3]);
						newObj.setCantidadPuertas(valuesArray[4]);
						break;
                }

                    if (inputValidation(newObj)) {

						var xhttp = new XMLHttpRequest(); //Instancio el objeto
						xhttp.onreadystatechange = function() {
							if (this.readyState == 4)
							{
								if (this.status == 200) {
									//Acción a ejecutar cuando el estado es 200 ok y el readyState=4 (respuesta lista)
									newObj.id = JSON.parse(this.responseText).id;
									console.log(newObj.toString());
									finalOutputArray.push(newObj);
									renderTable(finalOutputArray, propNames);
									hideForm();
								}else{
									serverError();
								}
								toggleSpinner();
							}
							
						}; //Configúro manejador para cambio de estado
						xhttp.open("PUT", "https://localhost:5001/Vehiculos/Insertar" + selectedValue, true); //Inicializo la solicitud
						xhttp.setRequestHeader('Content-Type', 'application/json');
						let requestBody = JSON.stringify( newObj );
						xhttp.send( requestBody ); //Envio la solicitud
                    }else {
                        alert('Ha habido un error en los datos ingresados');
                    }
            }else {
                renderForm(null, false);
            }
        }

        function inputValidation(obj){
            validationResult = false;
            if (obj) {
                if (obj.fabricante && obj.modelo && obj.añoLanzamiento && !isNaN(obj.id) && isNaN(obj.fabricante) && isNaN(obj.modelo) && !isNaN(obj.añoLanzamiento)) {
                    className = obj.constructor.name;
                    switch (className) {
                        case 'Camioneta':
                            if (obj.transmision4x4 && isNaN(obj.transmision4x4)) {
                                validationResult = true;
                            }
                            break;
                        case 'Auto': 
							console.log(obj);
                            if (obj.cantidadPuertas && !isNaN(obj.cantidadPuertas)) {
                                validationResult = true;
                            }
                            break;
                    }
                }
            }
            return validationResult;
        }

        function onEdit(){
            let selectedValue = document.getElementById('formSelect').value;
            let valuesArray = getInputsValues();
            let newObj;
            let target;

            switch (selectedValue) {
                case 'Camioneta':
                    newObj = new Camioneta();
                    newObj.id = valuesArray[0];
                    newObj.fabricante = valuesArray[1];
                    newObj.modelo = valuesArray[2];
                    newObj.setAñoLanzamiento(valuesArray[3]);
                    newObj.setTransmision4x4(valuesArray[4]);
                    break;
                case 'Auto':
					newObj = new Auto();
                    newObj.id = valuesArray[0];
                    newObj.fabricante = valuesArray[1];
                    newObj.modelo = valuesArray[2];
                    newObj.setAñoLanzamiento(valuesArray[3]);
                    newObj.setCantidadPuertas(valuesArray[4]);
                    break;
            }
            if (inputValidation(newObj) ) {
                targetIndex = finalOutputArray.findIndex((e) => {
                    return e.id == newObj.id;
                })

				toggleSpinner();
				postDataByFetchAsync('https://localhost:5001/Vehiculos/Modificar' + selectedValue, newObj).then( response => {
					toggleSpinner();
					console.log(response.status);
					if (response.status == 200) {
						finalOutputArray[targetIndex] = newObj;
					} else {
						console.log(response);
						serverError();
					}
					
					hideForm();
					renderTable(finalOutputArray, propNames);
				});
            }else {
                alert('Ha habido un error en los datos ingresados.');
            }
        }

		async function postDataByFetchAsync(url = '', data = {}) {
			console.log(url);
			console.log(JSON.stringify(data));
			// Opciones por defecto estan marcadas con un *
			const response = await fetch(url, {
				method: 'POST', // *GET, POST, PUT, DELETE, etc.
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data) // body data type must match "Content-Type" header
			});
			return response;
		}

		async function putDataByFetchAsync(url = '', data = {}) {
			console.log(url);
			console.log(JSON.stringify(data));
			// Opciones por defecto estan marcadas con un *
			const response = await fetch(url, {
				method: 'PUT', // *GET, POST, PUT, DELETE, etc.
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data) // body data type must match "Content-Type" header
			});
			return response;
		}

		function postDataByFetch(url = '', data = {}) {
			console.log(url);
			console.log(JSON.stringify(data));
			// Opciones por defecto estan marcadas con un *
			const response = fetch(url, {
				method: 'POST', // *GET, POST, PUT, DELETE, etc.
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data) // body data type must match "Content-Type" header
			});
			return response;
		}

		function getDataByFetch(url = '') {
			// Opciones por defecto estan marcadas con un *
			const response = fetch(url, {
				method: 'GET', // *GET, POST, PUT, DELETE, etc.
			});
			return response;
		}

		function putDataByFetch(url = '', data = {}) {
			console.log(url);
			console.log(JSON.stringify(data));
			// Opciones por defecto estan marcadas con un *
			const response = fetch(url, {
				method: 'PUT', // *GET, POST, PUT, DELETE, etc.
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data) // body data type must match "Content-Type" header
			});
			return response;
		}

		async function deleteDataByFetchAsync(url = '', data = {}) {
			console.log(JSON.stringify(data));
			// Opciones por defecto estan marcadas con un *
			const response = await fetch(url, {
				method: 'DELETE', // *GET, POST, PUT, DELETE, etc.
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify(data) // body data type must match "Content-Type" header
			});
			return response;
		}



		function serverError(){
			alert('Ha habido un error en la petición al servidor.');
		}


        async function onDeleteForm(){
			toggleSpinner();
            let idTarget = document.getElementById('inputid').value;

			let params = {id: idTarget};

			let response = await deleteDataByFetchAsync("https://localhost:5001/Vehiculos/EliminarVehiculo", params);
			if (response.status == 200) {
				finalOutputArray = finalOutputArray.filter(x => x.id != idTarget);
				renderTable(finalOutputArray, propNames);
				hideForm();

				toggleSpinner();
			}else{
				serverError();
				toggleSpinner();
			}
        }

        function onCancel() {
            hideForm();
        }
        /************************** ABM ******************************/



        
        /************************ MAIN ***********************/
		getInitialData(); // Obtiene los datos del servidor

        

        /******************** FIN MAIN **********************/
    </script>
</html>